{% extends "base.html" %}

{% block title %}
    Dashboard with Multiple Tabs
{% endblock %}

{% block content %}
<h1 class="mb-4">{{ current_user.first_name }}'s Dashboard</h1>

<!-- FILTER FORM -->
<form id="filterForm" class="row g-3 mb-4">
  <!-- Course filter -->
  <div class="col-auto">
    <label for="course" class="form-label">Course:</label>
    <select class="form-control" name="course" id="course">
      <option value="">All Courses</option>
      {% for c in user_courses %}
      <option value="{{ c.courseID }}">{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Round filter -->
  <div class="col-auto">
    <label for="round" class="form-label">Round:</label>
    <select class="form-control" name="round" id="round">
      <option value="">All Rounds</option>
      {% for r in user_rounds %}
      <option value="{{ r.roundID }}">
        {{ r.course.name }} - {{ r.date_played }}
      </option>{
      {% endfor %}
    </select>
  </div>

  <!-- Date range filter -->
  <div class="col-auto">
    <label for="startDate" class="form-label">Start Date:</label>
    <input type="date" class="form-control" name="startDate" id="startDate" />
  </div>
  <div class="col-auto">
    <label for="endDate" class="form-label">End Date:</label>
    <input type="date" class="form-control" name="endDate" id="endDate" />
  </div>

  <div class="col-auto mt-4">
    <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
  </div>
</form>

<!-- BOOTSTRAP TABS NAVIGATION -->
<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
  <!-- Overall Tab -->
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overall-tab" data-bs-toggle="tab"
      data-bs-target="#overallTabPane" type="button" role="tab"
      aria-controls="overallTabPane" aria-selected="true">
      Overall
    </button>
  </li>
  <!-- Tee Tab -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tee-tab" data-bs-toggle="tab"
      data-bs-target="#teeTabPane" type="button" role="tab"
      aria-controls="teeTabPane" aria-selected="false">
      Tee
    </button>
  </li>
  <!-- Approach Tab -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="approach-tab" data-bs-toggle="tab"
      data-bs-target="#approachTabPane" type="button" role="tab"
      aria-controls="approachTabPane" aria-selected="false">
      Approach
    </button>
  </li>
  <!-- Short Game Tab -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="shortgame-tab" data-bs-toggle="tab"
      data-bs-target="#shortGameTabPane" type="button" role="tab"
      aria-controls="shortGameTabPane" aria-selected="false">
      Short Game
    </button>
  </li>
  <!-- Putting Tab -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="putting-tab" data-bs-toggle="tab"
      data-bs-target="#puttingTabPane" type="button" role="tab"
      aria-controls="puttingTabPane" aria-selected="false">
      Putting
    </button>
  </li>
</ul>

<!-- TAB CONTENT CONTAINER -->
<div class="tab-content" id="dashboardTabsContent">
  <!-- Overall Tab Pane -->
  <div class="tab-pane fade show active p-3" id="overallTabPane" role="tabpanel" aria-labelledby="overall-tab">
    <h4>Overall</h4>
    <!-- Example Cards -->
    <div class="row mb-3">
      <!-- Scoring Average card -->
      <div class="col-sm-6 col-md-4 col-lg-2 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Scoring Average</h6>
            <h3 class="card-title" id="scoringAvgCard">--</h3>
          </div>
        </div>
      </div>
      <!-- Score vs Par card -->
      <div class="col-sm-6 col-md-4 col-lg-2 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Scoring vs. Par</h6>
            <h3 class="card-title" id="scoringVsParCard">--</h3>
          </div>
        </div>
      </div>
      <!-- Total Rounds card -->
      <div class="col-sm-6 col-md-4 col-lg-2 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Total Rounds</h6>
            <h3 class="card-title" id="totalRoundsCard">--</h3>
          </div>
        </div>
      </div>
      <!-- Par 3 Average -->
      <div class="col-sm-6 col-md-4 col-lg-2 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Par 3 Avg</h6>
            <h3 class="card-title" id="par3Card">--</h3>
          </div>
        </div>
      </div>
      <!-- Par 4 Average -->
      <div class="col-sm-6 col-md-4 col-lg-2 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Par 4 Avg</h6>
            <h3 class="card-title" id="par4Card">--</h3>
          </div>
        </div>
      </div>
      <!-- Par 5 Average -->
      <div class="col-sm-6 col-md-4 col-lg-2 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Par 5 Avg</h6>
            <h3 class="card-title" id="par5Card">--</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Strokes Gained Chart -->
    <h5>Strokes Gained Chart</h5>
    <canvas id="sgChart" width="400" height="200"></canvas>

    <!-- Distance Histogram -->
    <h5>Shot Distance Histogram</h5>
    <canvas id="distanceHistogram" width="400" height="200"></canvas>

    <!-- Scoring Trend Chart -->
    <h5>Scoring vs Par Trend</h5>
    <canvas id="roundPerformanceChart" width="400" height="200"></canvas>
    
  </div>

  <!-- Tee Tab Pane -->
  <div class="tab-pane fade p-3" id="teeTabPane" role="tabpanel" aria-labelledby="tee-tab">
    <h4>Tee Stats</h4>
    <div class="row mb-3">
      <!-- Card 1: Off the Tee SG -->
      <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">SG Off the Tee</h6>
            <h3 class="card-title" id="teeSGCard">--</h3>
          </div>
        </div>
      </div>
      <!-- Card 2: Average Tee Distance -->
      <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Avg Tee Distance</h6>
            <h3 class="card-title" id="teeDistanceCard">--</h3>
          </div>
        </div>
      </div>
      <!-- Card 3: In Play % -->
      <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">In Play %</h6>
            <h3 class="card-title" id="teeLieCard">--</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Miss Direction Fairway Visualization -->
    <h5>Miss Direction Visualization</h5>
    <div id="fairwayContainer" style="
        width: 100%;
        max-width: 500px; 
        height: 60px; 
        background-color: #567d46;
        position: relative; 
        border-radius: 30px;
        margin-bottom: 1em;
        overflow: hidden;
    ">
      <div id="leftMissSection" style="
          position: absolute; 
          left: 0; 
          top: 0; 
          height: 100%; 
          background-color: rgba(255, 0, 0, 0.3);
          text-align: center;
          line-height: 60px; 
          color: #fff; 
          font-weight: bold;
      "></div>
      <div id="centerHitSection" style="
          position: absolute; 
          top: 0; 
          height: 100%; 
          background-color: rgba(255,255,255, 0.3);
          text-align: center; 
          line-height: 60px; 
          color: #fff; 
          font-weight: bold;
      "></div>
      <div id="rightMissSection" style="
          position: absolute; 
          top: 0; 
          height: 100%; 
          background-color: rgba(255, 0, 0, 0.3);
          text-align: center;
          line-height: 60px; 
          color: #fff; 
          font-weight: bold;
      "></div>
    </div>
  </div>

  <!-- Approach Tab Pane -->
  <div class="tab-pane fade p-3" id="approachTabPane" role="tabpanel" aria-labelledby="approach-tab">
    <h4>Approach Stats</h4>

    <div class="row mb-3">
      <!-- Card: Average SG Approach -->
      <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Avg SG Approach</h6>
            <h3 class="card-title" id="approachSGCard">--</h3>
          </div>
        </div>
      </div>
      <!-- Card: % GIR (Approach) -->
      <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">% GIR</h6>
            <h3 class="card-title" id="approachGirCard">--</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- D3.js Approach Miss Directions Visualization -->
    <h5>Approach Miss Directions</h5>
    <div id="approachMissChart" style="width:400px; height:400px;"></div>

    <!-- Approach Shots Table -->
    <h5 class="mt-4">Approach Shots by Distance</h5>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Distance Range</th>
          <th>SG per Shot</th>
          <th>Proximity to Hole (ft)</th>
          <th>Green Hit %</th>
        </tr>
      </thead>
      <tbody id="approachTableBody">
        <!-- Will be populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Short Game Tab Pane -->
  <div class="tab-pane fade p-3" id="shortGameTabPane" role="tabpanel" aria-labelledby="shortgame-tab">
    <h4>Short Game Stats</h4>
    <div class="row mb-3">
      <!-- Card: Up & Down Percentage -->
      <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Up & Down %</h6>
            <h3 class="card-title" id="upDownPercentCard">--</h3>
          </div>
        </div>
      </div>
      <!-- Card: SG Around the Green -->
      <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">SG Around the Green</h6>
            <h3 class="card-title" id="aroundGreenSGCard">--</h3>
          </div>
        </div>
      </div>
    </div>
    <!-- Bunker Shots Table-->
    <h5>Bunker Shots</h5>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Distance</th>
          <th>Avg Proximity (ft)</th>
          <th>Up & Down %</th>
        </tr>
      </thead>
      <tbody id="bunkerTableBody">
        <!-- Populated by JavaScript -->
      </tbody>
    </table>
    <!-- Non-Bunker Shots Table-->
    <h5>Non-Bunker Shots</h5>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Distance</th>
          <th>Avg Proximity (ft)</th>
          <th>Up & Down %</th>
        </tr>
      </thead>
      <tbody id="nonBunkerTableBody">
        <!-- Populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Putting Tab Pane -->
  <div class="tab-pane fade p-3" id="puttingTabPane" role="tabpanel" aria-labelledby="putting-tab">
    <h4>Putting Stats</h4>
    <div class="row mb-3">
      <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
        <div class="card text-center shadow">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">SG Putting</h6>
            <h3 class="card-title" id="puttingSGCard">--</h3>
          </div>
        </div>
      </div>
    </div>
    <!-- Putting Stats Table -->
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Distance Range</th>
          <th>Make Rate (%)</th>
          <th>3-Putt Avoid (%)</th>
          <th>Avg Next Putt Distance (ft)</th>
        </tr>
      </thead>
      <tbody id="puttingTableBody">
        <!-- Populated by JavaScript -->
      </tbody>
    </table>
  </div>
</div>

<!-- SCRIPTS -->
<!-- Bootstrap JS Bundle (including Popper for tabs) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js (used in other tabs) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<!-- D3.js for the Approach visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
  // Overall references
  const filterForm = document.getElementById("filterForm");
  const sgChartCanvas = document.getElementById("sgChart");
  const distanceHistogramCanvas = document.getElementById("distanceHistogram");

  // Overall tab card elements
  const scoringAvgCard = document.getElementById("scoringAvgCard");
  const scoringVsParCard = document.getElementById("scoringVsParCard");
  const totalRoundsCard = document.getElementById("totalRoundsCard");
  const par3Card = document.getElementById("par3Card");
  const par4Card = document.getElementById("par4Card");
  const par5Card = document.getElementById("par5Card");

  // Overall tab: Reference for the line chart
  const roundPerformanceCanvas = document.getElementById("roundPerformanceChart");
  let roundPerformanceChart;

  // Tee tab elements
  const teeSGCard = document.getElementById("teeSGCard");
  const teeDistanceCard = document.getElementById("teeDistanceCard");
  let teeMissChart;

  // Approach tab elements
  const approachSGCard = document.getElementById("approachSGCard");
  const approachGirCard = document.getElementById("approachGirCard");
  // (We use D3 for the miss directions)

  // Short Game tab elements
  const upDownPercentCard = document.getElementById("upDownPercentCard");
  const aroundGreenSGCard = document.getElementById("aroundGreenSGCard");

  // Putting tab elements
  const puttingSGCard = document.getElementById("puttingSGCard");

  // Chart.js variables for other charts
  let sgChart;           
  let distanceHistogram; 

  filterForm.addEventListener("submit", function(e) {
    e.preventDefault();
    updateDashboard();
  });

  async function updateRoundPerformanceChart(params) {
    const roundRes = await fetch(`/api/rounds?${params.toString()}`);
    const roundData = await roundRes.json();

    const labels = roundData.map(r => `Round ${r.roundID}`);
    const scores = roundData.map(r => r.score_to_par);
    const tooltips = roundData.map(r => ({
      course: r.course_name,
      date: r.date_played,
      score: r.score_to_par
    }));

    if (roundPerformanceChart) {
      roundPerformanceChart.destroy();
    }

    roundPerformanceChart = new Chart(roundPerformanceCanvas, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "Score to Par",
          data: scores,
          borderColor: "rgba(75, 192, 192, 1)",
          backgroundColor: "rgba(75, 192, 192, 0.2)",
          borderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: "rgba(75, 192, 192, 1)"
        }]
      },
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              title: (context) => {
                const index = context[0].dataIndex;
                return `Course: ${tooltips[index].course}`;
              },
              label: (context) => {
                const index = context.dataIndex;
                return [
                  `Date Played: ${tooltips[index].date}`,
                  `Score: ${tooltips[index].score}`
                ];
              }
            }
          },
          annotation: {
            annotations: {
              zeroLine: {
                type: 'line',
                yMin: 0,
                yMax: 0,
                borderColor: 'red',
                borderDash: [5, 5],
                borderWidth: 2,
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: "Rounds Played"
            },
            ticks: { display: false }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Score to Par" }
          }
        }
      }
    });
  }

      async function updateApproachTable(params) {
      try {
        // Fetch approach table data from the API endpoint.
        const response = await fetch(`/api/approach_table?${params.toString()}`);
        if (!response.ok) throw new Error("Failed to fetch Approach Table data");

        const data = await response.json(); // { approachData: [{ distanceRange, sgPerShot, avgProximity, greenHitPct }, ...] }
        const tableBody = document.getElementById("approachTableBody");
        if (!tableBody) {
          console.error("No table body with id 'approachTableBody' found.");
          return;
        }

        // Clear existing rows.
        tableBody.innerHTML = "";
        
        // Populate rows.
        if (data.approachData && Array.isArray(data.approachData)) {
          data.approachData.forEach(row => {

            // Debug to see the actual values
            console.log("Row data:", row);

            // Check if sgPerShot is > 0 to prepend '+'
            const displaySg = row.sgPerShot > 0 ? `+${row.sgPerShot}` : row.sgPerShot;
            
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.distanceRange}</td>
              <td>${displaySg}</td>
              <td>${row.avgProximity}</td>
              <td>${row.greenHitPct}%</td>
            `;
            tableBody.appendChild(tr);
          });
        }
      } catch (err) {
        console.error("Error updating approach table:", err);
      }
    }
  async function updateDashboard() {
    const params = new URLSearchParams({
      course: document.getElementById("course").value,
      round: document.getElementById("round").value,
      startDate: document.getElementById("startDate").value,
      endDate: document.getElementById("endDate").value,
    });

    // 1) Overall Stats
    const statsRes = await fetch(`/api/dashboard_stats?${params.toString()}`);
    const statsData = await statsRes.json();
    
    // Obtain the number of rounds
    totalRoundsCard.textContent = statsData.total_rounds;

    if (statsData.total_rounds === 0){
      scoringAvgCard.textContent = "--";
      scoringVsParCard.textContent = "--";
      par3Card.textContent = "--";
      par4Card.textContent = "--";
      par5Card.textContent = "--";
    } else {
      scoringAvgCard.textContent = statsData.scoring_avg;
      
      // Ensure that the + sign if > 0
      if (statsData.scoring_avg_to_par > 0){
          scoringVsParCard.textContent = `+${statsData.scoring_avg_to_par}`;
      } else {
          scoringVsParCard.textContent = statsData.scoring_avg_to_par;
      }
      
      par3Card.textContent = statsData.par3_avg;
      par4Card.textContent = statsData.par4_avg;
      par5Card.textContent = statsData.par5_avg;
    }

    // 2) Overall Strokes Gained Chart
    const sgRes = await fetch(`/api/sg_by_shot_type?${params.toString()}`);
    const sgData = await sgRes.json();
    if (sgChart) {
      sgChart.destroy();
    }
    const barColors = sgData.values.map(v => v >= 0 ? "rgba(0, 128, 0, 0.6)" : "rgba(255, 0, 0, 0.6)");
    const borderColors = sgData.values.map(v => v >= 0 ? "rgba(0, 128, 0, 1)" : "rgba(255, 0, 0, 1)");

    sgChart = new Chart(sgChartCanvas, {
      type: "bar",
      data: {
        labels: sgData.labels,
        datasets: [{
          label: "Avg Strokes Gained",
          data: sgData.values,
          backgroundColor: barColors,
          borderColor: borderColors,
          borderWidth: 1,
        }],
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    updateRoundPerformanceChart(params);

    // 3) Tee Stats
    const teeRes = await fetch(`/api/tee_stats?${params.toString()}`);
    const teeData = await teeRes.json();

    if (statsData.total_rounds === 0){
      teeSGCard.textContent = "--";
      teeDistanceCard.textContent = "--";
      document.getElementById("teeLieCard").textContent = "--" + "%";
    } else {
      
      if (teeData.avg_off_tee_sg > 0){
          teeSGCard.textContent = `+${teeData.avg_off_tee_sg}`;
      } else {
          teeSGCard.textContent = teeData.avg_off_tee_sg;
      }
      
      teeDistanceCard.textContent = Math.round(teeData.avg_tee_distance) + "yds";
      document.getElementById("teeLieCard").textContent = teeData.cumulativeLiePct + "%";
    }
    let leftCount = 0, rightCount = 0, centerCount = 0;
    const directions = teeData.miss_directions;
    const counts = teeData.miss_counts;
    let totalShots = 0;
    for (let i = 0; i < directions.length; i++) {
      const dir = directions[i].toLowerCase();
      const count = counts[i];
      totalShots += count;
      if (dir.includes("left")) {
        leftCount += count;
      } else if (dir.includes("right")) {
        rightCount += count;
      } else {
        centerCount += count;
      }
    }
    if (totalShots > 0) {
      const leftPct = (leftCount / totalShots) * 100;
      const rightPct = (rightCount / totalShots) * 100;
      const centerPct = (centerCount / totalShots) * 100;
      document.getElementById("leftMissSection").style.width = `${leftPct}%`;
      document.getElementById("leftMissSection").textContent = leftCount > 0 ? `Left ${leftPct.toFixed(1)}%` : "";
      document.getElementById("centerHitSection").style.width = `${centerPct}%`;
      document.getElementById("centerHitSection").style.left = `${leftPct}%`;
      document.getElementById("centerHitSection").textContent = centerCount > 0 ? `Fairway ${centerPct.toFixed(1)}%` : "";
      document.getElementById("rightMissSection").style.width = `${rightPct}%`;
      document.getElementById("rightMissSection").style.left = `${leftPct + centerPct}%`;
      document.getElementById("rightMissSection").textContent = rightCount > 0 ? `Right ${rightPct.toFixed(1)}%` : "";
    }

    // 4) Approach Stats (Using D3.js for the miss visualization)
    const approachRes = await fetch(`/api/approach_stats?${params.toString()}`);
    const approachData = await approachRes.json();
    
    if (statsData.total_rounds === 0){
      approachSGCard.textContent = "--";
      approachGirCard.textContent = "--";
    } else {

      // Ensure that the + sign if > 0
      if (approachData.avg_approach_sg > 0){
        approachSGCard.textContent = `+${approachData.avg_approach_sg}`;
      } else {
        approachSGCard.textContent = approachData.avg_approach_sg;
      }
      
      approachGirCard.textContent = approachData.gir_percent + "%";
    }

    // Prepare D3 data for miss directions.
    const missData = approachData.miss_directions.map((dir, i) => ({
      direction: dir,
      frequency: approachData.miss_counts[i]
    }));

    // For the purposes of the D3 visualization, 
    // we calculate "greens_hit" from the Shot-based method.
    // (Note: You may adjust this if needed.)
    const totalApproachShotsForD3 = approachData.total_approach_shots || 0;
    // Here using greens_hit field from the API which is the shot-based value.
    const girShots = Math.round((approachData.greens_hit / 100) * totalApproachShotsForD3);

    // Remove any existing SVG from the container.
    d3.select("#approachMissChart").selectAll("*").remove();

    const width = 400,
          height = 400,
          margin = 20,
          radius = Math.min(width, height) / 2 - margin;

    const svg = d3.select("#approachMissChart")
                  .append("svg")
                  .attr("width", width)
                  .attr("height", height)
                  .append("g")
                  .attr("transform", `translate(${width/2},${height/2})`);

    // Create a tooltip div.
    const tooltip = d3.select("body")
      .append("div")
      .attr("class", "d3-tooltip")
      .style("position", "absolute")
      .style("padding", "4px 8px")
      .style("font", "12px sans-serif")
      .style("background", "lightsteelblue")
      .style("border-radius", "4px")
      .style("pointer-events", "none")
      .style("opacity", 0);

    // For constant-angle slices.
    const numSlices = missData.length;
    const angleDelta = 2 * Math.PI / numSlices;
    const maxFreq = d3.max(missData, d => d.frequency);
    const rScale = d3.scaleLinear()
                     .domain([0, maxFreq])
                     .range([radius * 0.3, radius]);

    const dataWithAngles = missData.map((d, i) => ({
      direction: d.direction,
      frequency: d.frequency,
      startAngle: i * angleDelta + (22.5 * Math.PI / 180),
      endAngle: (i + 1) * angleDelta + (22.5 * Math.PI / 180)
    }));

    const arc = d3.arc()
                  .innerRadius(radius * 0.3)
                  .outerRadius(d => rScale(d.frequency))
                  .startAngle(d => d.startAngle)
                  .endAngle(d => d.endAngle);

    const color = d3.scaleOrdinal(d3.schemeSet2);

    svg.selectAll("path")
       .data(dataWithAngles)
       .enter()
       .append("path")
       .attr("d", arc)
       .attr("fill", (d, i) => color(i))
       .attr("stroke", "white")
       .style("stroke-width", "2px")
       .on("mouseover", function(event, d) {
          tooltip.transition().duration(200).style("opacity", 0.9);
          tooltip.html(`<strong>${d.direction}</strong>: ${d.frequency}`)
                 .style("left", (event.pageX + 10) + "px")
                 .style("top", (event.pageY - 28) + "px");
       })
       .on("mousemove", function(event, d) {
          tooltip.style("left", (event.pageX + 10) + "px")
                 .style("top", (event.pageY - 28) + "px");
       })
       .on("mouseout", function(event, d) {
          tooltip.transition().duration(500).style("opacity", 0);
       });

    const centerRadius = radius * 0.3;
    svg.append("circle")
       .attr("cx", 0)
       .attr("cy", 0)
       .attr("r", centerRadius)
       .attr("fill", "green")
       .attr("opacity", 0.8);

    svg.append("text")
       .attr("text-anchor", "middle")
       .attr("dy", "0.35em")
       .style("font-size", "14px")
       .style("fill", "white")
       .text(`Green: ${approachData.greens_hit.toFixed(1)}%`);

    // 5) Update Approach Shots Table
    await updateApproachTable(params);

    // 6) Short Game Stats
    const sgShortRes = await fetch(`/api/short_game_stats?${params.toString()}`);
    const sgShortData = await sgShortRes.json();
    
    if (statsData.total_rounds === 0){
      upDownPercentCard.textContent = "--";
      aroundGreenSGCard.textContent = "--";
    } else {
        if (sgShortData.avg_around_green_sg > 0){
          aroundGreenSGCard.textContent = `+${sgShortData.avg_around_green_sg}`;
        } else {
          aroundGreenSGCard.textContent = sgShortData.avg_around_green_sg;
        }
      upDownPercentCard.textContent = sgShortData.up_down_percent + "%";
      
    }

    const bunkerContainer = document.getElementById("bunkerTableBody");
    bunkerContainer.innerHTML = "";
   // If bunkerData is empty or each row has zeros, we'll show "--"
    const noBunkerData = !sgShortData.bunkerData || sgShortData.bunkerData.length === 0
                        || sgShortData.bunkerData.every(row => 
                              row.avgProximity === 0 && row.upDownPercent === 0
                            );

    if (!sgShortData.bunkerData) {
      console.warn("No bunkerData array in sgShortData");
      return; 
    }

    // Populate rows
    sgShortData.bunkerData.forEach(row => {
      const tr = document.createElement("tr");
      if (noBunkerData) {
        // Display distanceRange but all numeric values as "--"
        tr.innerHTML = `
          <td>${row.distanceRange}</td>
          <td>--</td>
          <td>--</td>
        `;
      } else {
        // Show actual data
        tr.innerHTML = `
          <td>${row.distanceRange}</td>
          <td>${row.avgProximity}</td>
          <td>${row.upDownPercent}%</td>
        `;
      }
      bunkerContainer.appendChild(tr);
    });

    // 2) Non-Bunker Shots Table
    const nonBunkerContainer = document.getElementById("nonBunkerTableBody");
    nonBunkerContainer.innerHTML = "";

    const noNonBunkerData = !sgShortData.nonBunkerData || sgShortData.nonBunkerData.length === 0
                            || sgShortData.nonBunkerData.every(row => 
                                row.avgProximity === 0 && row.upDownPercent === 0
                              );

    if (!sgShortData.nonBunkerData) {
      console.warn("No nonBunkerData array in sgShortData");
      return;
    }

    sgShortData.nonBunkerData.forEach(row => {
      const tr = document.createElement("tr");
      if (noNonBunkerData) {
        tr.innerHTML = `
          <td>${row.distanceRange}</td>
          <td>--</td>
          <td>--</td>
        `;
      } else {
        tr.innerHTML = `
          <td>${row.distanceRange}</td>
          <td>${row.avgProximity}</td>
          <td>${row.upDownPercent}%</td>
        `;
      }
      nonBunkerContainer.appendChild(tr);
    });

    // 7) Putting Stats
    const puttingRes = await fetch(`/api/putting_stats?${params.toString()}`);
    const puttingData = await puttingRes.json();
    
    if (statsData.total_rounds === 0){
      puttingSGCard.textContent = "--";
    } else {
      
      if (puttingData.avg_putting_sg > 0){
        puttingSGCard.textContent = `+${puttingData.avg_putting_sg}`;
      } else {
        puttingSGCard.textContent = puttingData.avg_putting_sg; // remains as is
      }
    }


    const puttingTableBody = document.getElementById("puttingTableBody");
    puttingTableBody.innerHTML = "";

    // Check if there's no or all-zero data
    const noPuttingData = !puttingData.puttingData || puttingData.puttingData.length === 0
      || puttingData.puttingData.every(row =>
          // adjust logic to your data structure
          row.makeRate === 0 && row.threePuttAvoid === 0 && row.avgNextPuttDist === 0
        );

    // Populate the table rows
    if (puttingData.puttingData && Array.isArray(puttingData.puttingData)) {
      puttingData.puttingData.forEach(row => {
        const tr = document.createElement("tr");
        if (noPuttingData) {
          // Display the distance range but show "--" for numeric columns
          tr.innerHTML = `
            <td>${row.distanceRange}</td>
            <td>--</td>
            <td>--</td>
            <td>--</td>
          `;
        } else {
          // Show actual values
          tr.innerHTML = `
            <td>${row.distanceRange}</td>
            <td>${row.makeRate}%</td>
            <td>${row.threePuttAvoid}%</td>
            <td>${row.avgNextPuttDist}</td>
          `;
        }
        puttingTableBody.appendChild(tr);
      });
    }
    // 8) Distance Histogram (Overall)
    const histRes = await fetch(`/api/distance_histogram?${params.toString()}`);
    const histData = await histRes.json();
    if (distanceHistogram) {
      distanceHistogram.destroy();
    }
    const distCtx = distanceHistogramCanvas.getContext("2d");
    distanceHistogram = new Chart(distCtx, {
      type: "bar",
      data: {
        labels: histData.bin_labels,
        datasets: [{
          label: "Count of Shots",
          data: histData.bin_counts,
          backgroundColor: "rgba(54, 162, 235, 0.6)",
          borderColor: "rgba(54, 162, 235, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            title: {
              display: true,
              text: "Distance From Hole (Yards)"
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: "Count of Shots"
            }
          }
        }
      }
    });
  }

 

  document.addEventListener("DOMContentLoaded", updateDashboard);
</script>

<style>
  .shot-card {
    border: 1px solid #dee2e6;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 5px;
    background-color: #fafafa;
  }

  /* Compass styles */
  .compass-container {
    position: relative;
    width: 250px;
    height: 250px;
    background-color: #f8f9fa;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #ccc;
  }
  .compass-buttons {
    position: relative;
    display: grid;
    width: 100%;
    height: 100%;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    justify-items: center;
    align-items: center;
  }
  .compass-btn {
    width: 70px;
    height: 70px;
    background-color: #e9ecef;
    border-radius: 50%;
    border: 1px solid #ccc;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }
  .compass-btn:hover {
    background-color: #dee2e6;
  }
  /* Positions for compass buttons in a 3x3 grid */
  .compass-buttons > .compass-btn:nth-child(1) { grid-column: 2; grid-row: 1; }
  .compass-buttons > .compass-btn:nth-child(2) { grid-column: 3; grid-row: 1; }
  .compass-buttons > .compass-btn:nth-child(3) { grid-column: 3; grid-row: 2; }
  .compass-buttons > .compass-btn:nth-child(4) { grid-column: 3; grid-row: 3; }
  .compass-buttons > .compass-btn:nth-child(5) { grid-column: 2; grid-row: 3; }
  .compass-buttons > .compass-btn:nth-child(6) { grid-column: 1; grid-row: 3; }
  .compass-buttons > .compass-btn:nth-child(7) { grid-column: 1; grid-row: 2; }
  .compass-buttons > .compass-btn:nth-child(8) { grid-column: 1; grid-row: 1; }

  /* Style for selected compass button */
  .compass-btn.selected {
    background-color: #0d6efd !important;
    color: #fff !important;
    border-color: #0d6efd !important;
  }
</style>
{% endblock %}
